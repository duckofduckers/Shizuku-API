# Q3JlYXRpdmVfU2hpemVrdV9NYXJrZXJfMTIzIT8=

import os
import sys

def main():
    base_path = "/storage/emulated/0/Android/data/org.qpython.qpy/files/lib/python3.12/site-packages"
    package_path = os.path.join(base_path, "shizuku_api")
    
    os.makedirs(package_path, exist_ok=True)
    
    init_code = """from .loader import load_shizuku_api

shizuku_api = load_shizuku_api()
run = shizuku_api.run
"""
    with open(os.path.join(package_path, "__init__.py"), "w") as f:
        f.write(init_code)
    
    loader_code = """import sys, types, os, time, random, string, subprocess, tty, termios, select

def _run(cmd):
    c="/storage/emulated/0/Android/data/org.qpython.qpy/files/cache"
    os.makedirs(c,exist_ok=True)
    f=os.path.join(c,"tmp_"+''.join(random.choices(string.ascii_lowercase+string.digits,k=8))+".sh")
    with open(f,"w") as x:x.write(cmd)
    old=termios.tcgetattr(sys.stdin)
    tty.setraw(sys.stdin.fileno())
    m,s=os.openpty()
    p=subprocess.Popen(f'rish -c "sh {f}"',shell=True,stdin=s,stdout=s,stderr=s,close_fds=True)
    os.close(s)
    try:
        while True:
            r,_,_=select.select([sys.stdin,m],[],[])
            if sys.stdin in r:
                d=os.read(sys.stdin.fileno(),1024)
                if d: os.write(m,d)
            if m in r:
                try: o=os.read(m,1024)
                except OSError: break
                if o: sys.stdout.write(o.decode(errors="replace")); sys.stdout.flush()
                else: break
    finally:
        termios.tcsetattr(sys.stdin,termios.TCSADRAIN,old)
    while os.path.exists(f):
        try: os.remove(f)
        except: pass
        time.sleep(0.05)

def _build_shizuku_module():
    m=types.ModuleType("shizuku_api")
    m._run=_run
    m.run=_run
    return m

def _build_loader_module():
    loader=types.ModuleType("shizuku_api.loader")
    def load_shizuku_api():
        return _build_shizuku_module()
    loader.load_shizuku_api=load_shizuku_api
    return loader

sys.modules["shizuku_api"]=_build_shizuku_module()
sys.modules["shizuku_api.loader"]=_build_loader_module()
"""
    with open(os.path.join(package_path, "loader.py"), "w") as f:
        f.write(loader_code)
    
    print(f"shizuku_api installed successfully in {package_path}")

if __name__ == "__main__":
    main()
